<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visor Excel ‚Äì Validaci√≥n + Depuraci√≥n</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f7f9fc;
      padding: 2rem;
      font-family: Arial, sans-serif;
    }
    .tab-content {
      margin-top: 1rem;
    }
    .grid-container {
      margin-bottom: 40px;
      padding: 10px;
      border: 1px solid #ddd;
      overflow-x: auto;
    }
    .gridjs-wrapper {
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">üìä Visor de Excel ‚Äì Validaci√≥n Mejorada</h1>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-prd" type="button">PRD</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-qas" type="button">QAS</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dev" type="button">DEV</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-prd">
      <h3 class="mt-3">Entorno: PRD</h3>
      <div id="grid-prd" class="grid-container"></div>
    </div>
    <div class="tab-pane fade" id="tab-qas">
      <h3 class="mt-3">Entorno: QAS</h3>
      <div id="grid-qas" class="grid-container"></div>
    </div>
    <div class="tab-pane fade" id="tab-dev">
      <h3 class="mt-3">Entorno: DEV</h3>
      <div id="grid-dev" class="grid-container"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const excelUrl = 'https://raw.githubusercontent.com/soporte123tat-code/Reporte-web/main/Reporte_2025-10-09.xlsx';

      const hojas = { PRD: 'grid-prd', QAS: 'grid-qas', DEV: 'grid-dev' };

      fetch(excelUrl)
        .then(res => {
          if (!res.ok) throw new Error(`Error HTTP ${res.status} al cargar Excel`);
          return res.arrayBuffer();
        })
        .then(buffer => {
          const workbook = XLSX.read(buffer, { type: 'array' });
          console.log("‚úÖ Hojas encontradas:", workbook.SheetNames);

          Object.entries(hojas).forEach(([hojaNombre, contenedorId]) => {
            const contenedor = document.getElementById(contenedorId);
            if (!contenedor) {
              console.error(`‚ùå Contenedor con id "${contenedorId}" NO encontrado en el DOM.`);
              return;
            }
            contenedor.innerHTML = '';

            if (!workbook.SheetNames.includes(hojaNombre)) {
              contenedor.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Hoja "${hojaNombre}" no encontrada en el archivo Excel.</div>`;
              return;
            }

            const hoja = workbook.Sheets[hojaNombre];
            let data = XLSX.utils.sheet_to_json(hoja, { header: 1 });

            if (!Array.isArray(data) || data.length < 2) {
              contenedor.innerHTML = `<div class="alert alert-info">‚ÑπÔ∏è La hoja "${hojaNombre}" no tiene datos √∫tiles para mostrar.</div>`;
              return;
            }

            const headers = data[0];
            const rawRows = data.slice(1);
            const validRows = rawRows.filter(row => Array.isArray(row));
            if (validRows.length < rawRows.length) {
              console.warn(`‚ö†Ô∏è [${hojaNombre}] Se ignoraron ${rawRows.length - validRows.length} filas mal formateadas.`);
            }

            let rows = validRows.map(row => {
              const newRow = Array.from(row);
              while (newRow.length < headers.length) newRow.push("");
              return newRow;
            });

            const activeCols = headers.map((_, i) =>
              !rows.every(r => {
                const val = r[i];
                return val === null || val === undefined || val === "";
              })
            );

            const filteredHeaders = [];
            const filteredRows = rows.map(() => []);

            headers.forEach((h, i) => {
              if (activeCols[i]) {
                filteredHeaders.push(h || `Col_${i}`);
                rows.forEach((r, idx) => filteredRows[idx].push(r[i]));
              }
            });

            rows = filteredRows.map(r => {
              const rowCopy = [...r];
              while (rowCopy.length < filteredHeaders.length) rowCopy.push("");
              return rowCopy.slice(0, filteredHeaders.length);
            });

            // ‚ö†Ô∏è DEPURACI√ìN: Mostrar info en consola
            console.log(`--- Datos para hoja ${hojaNombre} ---`);
            console.log("Headers:", filteredHeaders);
            console.log("Rows:", rows);
            rows.forEach((r, i) => console.log(`Row ${i}:`, r));

            const allValid = rows.every(r => Array.isArray(r) && r.length === filteredHeaders.length);
            if (!allValid) {
              console.error(`‚ùå Datos inv√°lidos en hoja "${hojaNombre}". Algunas filas tienen longitud distinta a headers.`);
              contenedor.innerHTML = `<div class="alert alert-danger">‚ùå Error: Datos inconsistentes en "${hojaNombre}".</div>`;
              return;
            }

            const columns = filteredHeaders.map((h, idx) => ({
              name: h,
              id: `${hojaNombre}_col_${idx}`,
              formatter: cell => cell ?? ""
            }));

            try {
              new gridjs.Grid({
                columns,
                data: rows,
                search: true,
                pagination: { enabled: true, limit: 10 },
                sort: true,
                resizable: true,
                language: {
                  search: { placeholder: 'üîç Buscar...' },
                  pagination: {
                    previous: 'Anterior',
                    next: 'Siguiente',
                    showing: 'Mostrando',
                    results: () => 'registros'
                  }
                }
              }).render(contenedor);
              console.log(`‚úÖ Renderizado exitoso para "${hojaNombre}"`);
            } catch (err) {
              console.error(`‚ùå Error renderizando tabla para "${hojaNombre}":`, err);
              contenedor.innerHTML = `<div class="alert alert-danger">‚ùå Error mostrando tabla de "${hojaNombre}".</div>`;
            }
          });
        })
        .catch(err => {
          console.error("‚ùå Error cargando Excel:", err);
          Object.values(hojas).forEach(id => {
            const c = document.getElementById(id);
            if (c) c.innerHTML = `<div class="alert alert-danger">‚ùå No se pudo cargar el archivo Excel.</div>`;
          });
        });
    });
  </script>
</body>
</html>
