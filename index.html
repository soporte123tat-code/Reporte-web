<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visualizaci√≥n Bit√°cora</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f7f9fc;
      padding: 2rem;
      font-family: Arial, sans-serif;
    }
    .tab-content {
      margin-top: 1rem;
    }
    .gridjs-wrapper {
      overflow-x: auto;
    }
    .grid-container {
      margin-bottom: 40px;
      padding: 10px;
      border: 1px solid #ddd;
      min-height: 200px;
      position: relative;
    }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      font-weight: bold;
      color: #555;
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">üìä Visualizaci√≥n Bit√°cora</h1>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-prd" type="button">PRD</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-qas" type="button">QAS</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dev" type="button">DEV</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-prd">
      <h3 class="mt-3">Entorno: PRD</h3>
      <div id="grid-prd" class="grid-container"></div>
    </div>
    <div class="tab-pane fade" id="tab-qas">
      <h3 class="mt-3">Entorno: QAS</h3>
      <div id="grid-qas" class="grid-container"></div>
    </div>
    <div class="tab-pane fade" id="tab-dev">
      <h3 class="mt-3">Entorno: DEV</h3>
      <div id="grid-dev" class="grid-container"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const gridInstances = {}; // guardar instancias
    const storedData = {};    // guardar datos
    const storedColumns = {}; // guardar columnas

    const excelUrl = 'https://raw.githubusercontent.com/soporte123tat-code/Reporte-web/main/Reporte_2025-10-09.xlsx';
    const hojas = { PRD: 'grid-prd', QAS: 'grid-qas', DEV: 'grid-dev' };

    function showLoading(contenedor, show=true) {
      let overlay = contenedor.querySelector('.loading-overlay');
      if (show) {
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.className = 'loading-overlay';
          overlay.innerText = '‚è≥ Cargando...';
          contenedor.appendChild(overlay);
        }
      } else {
        if (overlay) contenedor.removeChild(overlay);
      }
    }

    async function loadExcel() {
      try {
        const res = await fetch(excelUrl);
        if (!res.ok) throw new Error(`Error HTTP ${res.status}`);
        const buffer = await res.arrayBuffer();
        const workbook = XLSX.read(buffer, { type: 'array' });
        console.log("‚úÖ Hojas encontradas:", workbook.SheetNames);

        Object.entries(hojas).forEach(([hojaNombre, contenedorId]) => {
          const contenedor = document.getElementById(contenedorId);
          showLoading(contenedor, true);

          if (!workbook.SheetNames.includes(hojaNombre)) {
            contenedor.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Hoja "${hojaNombre}" no encontrada.</div>`;
            return;
          }

          const hoja = workbook.Sheets[hojaNombre];
          let data = XLSX.utils.sheet_to_json(hoja, { header: 1 });
          if (!Array.isArray(data) || data.length < 2) {
            contenedor.innerHTML = `<div class="alert alert-info">‚ÑπÔ∏è Hoja "${hojaNombre}" sin datos √∫tiles.</div>`;
            return;
          }

          const headers = data[0];
          const rawRows = data.slice(1).filter(r => Array.isArray(r));
          const rows = rawRows.map(row => {
            const newRow = Array.from(row);
            while (newRow.length < headers.length) newRow.push("");
            return newRow;
          });

          const activeCols = headers.map((_, i) =>
            !rows.every(r => r[i] === null || r[i] === undefined || r[i] === "")
          );

          const filteredHeaders = [];
          const filteredRows = rows.map(() => []);
          headers.forEach((h, i) => {
            if (activeCols[i]) {
              filteredHeaders.push(h || `Col_${i}`);
              rows.forEach((r, idx) => filteredRows[idx].push(r[i]));
            }
          });

          const finalRows = filteredRows.map(r => {
            while (r.length < filteredHeaders.length) r.push("");
            return r.slice(0, filteredHeaders.length);
          });

          const columns = filteredHeaders.map((h, idx) => ({
            name: h,
            id: `${hojaNombre}_col_${idx}`,
            formatter: cell => cell ?? ""
          }));

          storedData[hojaNombre] = finalRows;
          storedColumns[hojaNombre] = columns;

          if (!gridInstances[hojaNombre]) {
            // Crear grid por primera vez
            contenedor.innerHTML = '';
            const grid = new gridjs.Grid({
              columns,
              data: finalRows,
              search: true,
              pagination: { enabled: true, limit: 10 },
              sort: true,
              resizable: true,
              language: {
                search: { placeholder: 'üîç Buscar...' },
                pagination: { previous: 'Anterior', next: 'Siguiente', showing: 'Mostrando', results: () => 'registros' }
              }
            });
            grid.render(contenedor);
            gridInstances[hojaNombre] = grid;
          } else {
            // Actualizar grid existente
            const grid = gridInstances[hojaNombre];
            grid.updateConfig({ data: finalRows, columns }).forceRender();
          }

          showLoading(contenedor, false);
          console.log(`‚úÖ Grid renderizado para ${hojaNombre}`);
        });
      } catch (err) {
        console.error("‚ùå Error cargando Excel:", err);
        Object.values(hojas).forEach(id => {
          const c = document.getElementById(id);
          if (c) c.innerHTML = `<div class="alert alert-danger">‚ùå No se pudo cargar el archivo Excel.</div>`;
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadExcel();

      // Al cambiar de pesta√±a, forzar render del grid correspondiente
      document.querySelectorAll('.nav-link[data-bs-toggle="tab"]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', event => {
          const targetId = event.target.getAttribute('data-bs-target').replace('#tab-', '').toUpperCase();
          const grid = gridInstances[targetId];
          if (grid) grid.updateConfig({ data: storedData[targetId], columns: storedColumns[targetId] }).forceRender();
        });
      });
    });
  </script>
</body>
</html>
