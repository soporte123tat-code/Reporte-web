<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visualizaci√≥n Bit√°cora</title>

  <!-- Bootstrap y Grid.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f4f7fb;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      color: #333;
      padding: 2rem;
    }

    header {
      background: linear-gradient(90deg, #007bff, #6610f2);
      color: white;
      text-align: center;
      padding: 1.5rem;
      border-radius: 0.75rem;
      margin-bottom: 2rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    h1 {
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .nav-tabs .nav-link {
      font-weight: 500;
      color: #495057;
      border: none;
      border-bottom: 3px solid transparent;
    }

    .nav-tabs .nav-link.active {
      color: #0d6efd;
      border-color: #0d6efd;
      background-color: transparent;
    }

    .tab-content {
      margin-top: 1.5rem;
    }

    .card {
      border: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      border-radius: 0.75rem;
      padding: 1.5rem;
      background: #fff;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.6s ease-in-out;
    }

    .card.visible {
      opacity: 1;
    }

    .grid-container {
      margin-top: 1rem;
      min-height: 200px;
    }

    /* Overlay de carga */
    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.8);
      z-index: 10;
      font-weight: 500;
      color: #0d6efd;
      font-size: 1.1rem;
      transition: opacity 0.3s ease-in-out;
    }

    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
      margin-right: 8px;
    }

    .gridjs-search-input {
      border-radius: 0.5rem !important;
      border-color: #ced4da !important;
      padding: 0.4rem 0.75rem !important;
    }

    .gridjs-pagination {
      margin-top: 1rem !important;
    }
  </style>
</head>

<body>
  <header>
    <h1>üìä Visualizaci√≥n Bit√°cora</h1>
    <p class="mb-0">Monitoreo de entornos PRD, QAS y DEV</p>
  </header>

  <ul class="nav nav-tabs justify-content-center" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-prd" type="button">Producci√≥n (PRD)</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-qas" type="button">Calidad (QAS)</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dev" type="button">Desarrollo (DEV)</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-prd">
      <div class="card mt-3 visible">
        <h4 class="text-primary mb-3">Entorno: PRD</h4>
        <div class="loading-overlay"><div class="spinner-border text-primary" role="status"></div>Cargando datos...</div>
        <div id="grid-prd" class="grid-container"></div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-qas">
      <div class="card mt-3">
        <h4 class="text-primary mb-3">Entorno: QAS</h4>
        <div class="loading-overlay"><div class="spinner-border text-primary" role="status"></div>Cargando datos...</div>
        <div id="grid-qas" class="grid-container"></div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-dev">
      <div class="card mt-3">
        <h4 class="text-primary mb-3">Entorno: DEV</h4>
        <div class="loading-overlay"><div class="spinner-border text-primary" role="status"></div>Cargando datos...</div>
        <div id="grid-dev" class="grid-container"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const gridInstances = {};
    const storedData = {};
    const storedConfig = {};

    document.addEventListener("DOMContentLoaded", () => {
      const excelUrl = 'https://raw.githubusercontent.com/soporte123tat-code/Reporte-web/main/Reporte_2025-10-09.xlsx';
      const hojas = { PRD: 'grid-prd', QAS: 'grid-qas', DEV: 'grid-dev' };

      // Mostrar overlay de carga din√°mico
      function showLoading(container) {
        let overlay = container.querySelector('.dynamic-loader');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.className = 'dynamic-loader loading-overlay';
          overlay.innerHTML = `<div class="spinner-border text-primary" role="status"></div>Cargando datos...`;
          container.appendChild(overlay);
        }
      }

      // Ocultar overlay
      function hideLoading(container) {
        const overlay = container.querySelector('.dynamic-loader, .loading-overlay');
        if (overlay) overlay.style.opacity = '0';
        setTimeout(() => overlay?.remove(), 300);
      }

      // Leer Excel remoto
      fetch(excelUrl)
        .then(res => {
          if (!res.ok) throw new Error(`Error HTTP ${res.status}`);
          return res.arrayBuffer();
        })
        .then(buffer => {
          const workbook = XLSX.read(buffer, { type: 'array' });
          console.log("‚úÖ Hojas encontradas:", workbook.SheetNames);

          Object.entries(hojas).forEach(([hojaNombre, contenedorId]) => {
            const contenedor = document.getElementById(contenedorId);
            const card = contenedor.closest('.card');
            showLoading(card);

            if (!workbook.SheetNames.includes(hojaNombre)) {
              contenedor.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Hoja "${hojaNombre}" no encontrada.</div>`;
              hideLoading(card);
              return;
            }

            const hoja = workbook.Sheets[hojaNombre];
            const data = XLSX.utils.sheet_to_json(hoja, { header: 1 });
            if (data.length < 2) {
              contenedor.innerHTML = `<div class="alert alert-info">‚ÑπÔ∏è Hoja "${hojaNombre}" sin datos √∫tiles.</div>`;
              hideLoading(card);
              return;
            }

            const headers = data[0];
            let rows = data.slice(1).filter(r => Array.isArray(r));
            const activeCols = headers.map((_, i) => !rows.every(r => !r[i]));

            const filteredHeaders = [];
            const filteredRows = rows.map(() => []);
            headers.forEach((h, i) => {
              if (activeCols[i]) {
                filteredHeaders.push(h || `Col_${i}`);
                rows.forEach((r, idx) => filteredRows[idx].push(r[i] || ""));
              }
            });

            const columns = filteredHeaders.map((h, idx) => ({
              name: h,
              id: `${hojaNombre}_col_${idx}`,
              formatter: cell => cell ?? ""
            }));

            storedData[hojaNombre] = filteredRows;
            storedConfig[hojaNombre] = columns;

            const grid = new gridjs.Grid({
              columns,
              data: filteredRows,
              search: true,
              pagination: { enabled: true, limit: 10 },
              sort: true,
              resizable: true,
              language: {
                search: { placeholder: 'üîç Buscar...' },
                pagination: {
                  previous: 'Anterior',
                  next: 'Siguiente',
                  showing: 'Mostrando',
                  results: () => 'registros'
                }
              }
            });

            grid.render(contenedor).then(() => {
              hideLoading(card);
              card.classList.add('visible');
              fixSearchInputs();
            });

            gridInstances[hojaNombre] = grid;
          });
        })
        .catch(err => {
          console.error("‚ùå Error cargando Excel:", err);
          Object.values(hojas).forEach(id => {
            const c = document.getElementById(id);
            const card = c.closest('.card');
            if (c) c.innerHTML = `<div class="alert alert-danger">‚ùå No se pudo cargar el archivo Excel.</div>`;
            hideLoading(card);
          });
        });

      // Re-renderizar al cambiar pesta√±as
      const tabButtons = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');

      tabButtons.forEach(btn => {
        btn.addEventListener('shown.bs.tab', event => {
          const hojaKey = event.target.getAttribute('data-bs-target').replace('#tab-', '').toUpperCase();
          const contenedor = document.getElementById(`grid-${hojaKey.toLowerCase()}`);
          const card = contenedor.closest('.card');

          showLoading(card);
          card.classList.remove('visible');

          function tryRefreshGrid(attempt = 0) {
            const grid = gridInstances[hojaKey];
            const rows = storedData[hojaKey];
            const cols = storedConfig[hojaKey];

            if (grid && Array.isArray(rows) && Array.isArray(cols)) {
              try {
                grid.updateConfig({ data: rows, columns: cols }).forceRender();
                console.log(`üîÑ Refrescado "${hojaKey}"`);
                hideLoading(card);
                setTimeout(() => card.classList.add('visible'), 200);
                fixSearchInputs();
              } catch (err) {
                console.warn(`‚ö†Ô∏è Error refrescando ${hojaKey}:`, err);
                hideLoading(card);
              }
            } else if (attempt < 5) {
              console.log(`‚è≥ Esperando datos de ${hojaKey}... intento ${attempt + 1}`);
              setTimeout(() => tryRefreshGrid(attempt + 1), 500);
            } else {
              console.warn(`‚ö†Ô∏è No se pudo refrescar "${hojaKey}" despu√©s de varios intentos.`);
              hideLoading(card);
            }
          }

          tryRefreshGrid();
        });
      });

      // Fix del warning de id/name
      function fixSearchInputs() {
        document.querySelectorAll('.gridjs-search-input').forEach((el, idx) => {
          if (!el.id) el.id = `gridjs_search_${idx}`;
          if (!el.name) el.name = `gridjs_search_${idx}`;
        });
      }

      setTimeout(fixSearchInputs, 1500);
    });
  </script>
</body>
</html>
