<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visor Excel ‚Äì PRD / QAS / DEV (Versi√≥n defensiva)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f7f9fc;
      padding: 2rem;
      font-family: Arial, sans-serif;
    }
    .tab-content {
      margin-top: 1rem;
    }
    .gridjs-wrapper {
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">üìä Visor de Excel ‚Äì PRD / QAS / DEV</h1>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-prd" type="button">PRD</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-qas" type="button">QAS</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dev" type="button">DEV</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-prd">
      <h3 class="mt-3">Entorno: PRD</h3>
      <div id="grid-prd"></div>
    </div>
    <div class="tab-pane fade" id="tab-qas">
      <h3 class="mt-3">Entorno: QAS</h3>
      <div id="grid-qas"></div>
    </div>
    <div class="tab-pane fade" id="tab-dev">
      <h3 class="mt-3">Entorno: DEV</h3>
      <div id="grid-dev"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const excelUrl = 'https://raw.githubusercontent.com/soporte123tat-code/Reporte-web/main/Reporte_2025-10-09.xlsx';

    fetch(excelUrl)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.arrayBuffer();
      })
      .then(buffer => {
        const workbook = XLSX.read(buffer, { type: 'array' });
        console.log("Hojas encontradas:", workbook.SheetNames);

        const hojas = { PRD: 'grid-prd', QAS: 'grid-qas', DEV: 'grid-dev' };

        Object.entries(hojas).forEach(([hojaNombre, contenedorId]) => {
          const contenedor = document.getElementById(contenedorId);
          if (!contenedor) {
            console.warn(`Contenedor con id "${contenedorId}" no encontrado en el DOM.`);
            return;
          }
          contenedor.innerHTML = '';

          const hoja = workbook.Sheets[hojaNombre];
          if (!hoja) {
            contenedor.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Hoja "${hojaNombre}" no encontrada.</div>`;
            return;
          }

          let data = XLSX.utils.sheet_to_json(hoja, { header: 1 });
          if (!Array.isArray(data) || data.length < 2) {
            contenedor.innerHTML = `<div class="alert alert-info">‚ÑπÔ∏è La hoja "${hojaNombre}" no tiene datos √∫tiles.</div>`;
            return;
          }

          const headers = data[0];
          let rows = data.slice(1).map(row => {
            const newRow = [...row];
            while (newRow.length < headers.length) {
              newRow.push("");
            }
            return newRow;
          });

          // Filtrar columnas que est√©n completamente vac√≠as
          const activeCols = headers.map((_, i) => {
            return !rows.every(r => {
              const v = r[i];
              return v === null || v === undefined || v === "";
            });
          });

          const filteredHeaders = [];
          const filteredRows = rows.map(() => []);

          headers.forEach((h, i) => {
            if (activeCols[i]) {
              filteredHeaders.push(h || `Col_${i}`);
              rows.forEach((r, rIndex) => {
                filteredRows[rIndex].push(r[i]);
              });
            }
          });

          if (filteredHeaders.length === 0) {
            contenedor.innerHTML = `<div class="alert alert-info">‚ÑπÔ∏è No hay columnas con datos para mostrar en "${hojaNombre}".</div>`;
            return;
          }

          const columns = filteredHeaders.map((h, idx) => ({
            name: h,
            id: `${hojaNombre}_col_${idx}`,
            formatter: cell => cell ?? ""
          }));

          try {
            new gridjs.Grid({
              columns: columns,
              data: filteredRows,
              search: true,
              pagination: { enabled: true, limit: 10 },
              sort: true,
              resizable: true,
              language: {
                search: { placeholder: 'üîç Buscar...' },
                pagination: {
                  previous: 'Anterior',
                  next: 'Siguiente',
                  showing: 'Mostrando',
                  results: () => 'registros'
                }
              }
            }).render(contenedor);
            console.log(`Renderizado exitoso para "${hojaNombre}"`);
          } catch (err) {
            console.error(`Error al renderizar hoja "${hojaNombre}":`, err);
            contenedor.innerHTML = `<div class="alert alert-danger">‚ùå Error al mostrar tabla de "${hojaNombre}".</div>`;
          }
        });
      })
      .catch(err => {
        console.error("Error cargando Excel:", err);
        document.getElementById("grid-prd").innerHTML =
          `<div class="alert alert-danger">‚ùå No se pudo cargar el archivo Excel.</div>`;
      });
  </script>
</body>
</html>
